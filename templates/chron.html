{% extends "base.html" %}
{% block title %}Chron - Column Selector{% endblock %}
{% block content %}
  <!-- ReturnsTable selector without the upload option -->
  <div class="table-select">
    <select class="returnsTableSelector" id="returnsTableSelectChron">
      <option value="">Select Returns Table</option>
      {% for table in returns_tables %}
        <option value="{{ table.id }}">
          {{ table.name }} â€” {{ table.upload_time.strftime('%Y-%m-%d %H:%M:%S') if table.upload_time else 'N/A' }}
        </option>
      {% endfor %}
    </select>
  </div>

  <!-- Column selector and display remain unchanged -->
  <div class="column-selector" style="margin-top:20px;">
    <select id="columnSelect">
      <option value="" disabled selected>Select Column</option>
    </select>
    <button id="showColumn">Show Column</button>
  </div>
  <div id="columnDisplay">
    <!-- Selected column details will be displayed here -->
  </div>

  <!-- Factiva upload section remains unchanged -->
  {% if returns_tables|length > 0 %}
  <div class="factiva-upload">
    <h2>Upload Factiva Articles</h2>
    <form id="factivaForm" action="/chron" method="POST" enctype="multipart/form-data">
      <input type="hidden" name="returns_table_id" id="returnsTableId">
      <input type="file" name="factiva_files" accept=".html" multiple required>
      <button type="submit">Upload</button>
    </form>
  </div>
  <div class="factiva-list">
    <h3>Factiva Articles</h3>
    <ul id="factivaArticlesList">
      {% for article in factiva_articles %}
        <li>{{ article.headline }} by {{ article.author }}</li>
      {% else %}
        <li>No Factiva articles uploaded.</li>
      {% endfor %}
    </ul>
  </div>
  {% endif %}
{% endblock %}
{% block scripts %}
  <script>
    // When a ReturnsTable is selected, update the hidden field, fetch columns and factiva articles
    document.getElementById('returnsTableSelectChron').addEventListener('change', function(){
      const tableId = this.value;
      document.getElementById('returnsTableId').value = tableId || "";
      
      if(!tableId) {
        document.getElementById('columnSelect').innerHTML = '<option value="" disabled selected>Select Column</option>';
        document.getElementById('factivaArticlesList').innerHTML = '<li>No Factiva articles uploaded.</li>';
        return;
      }
      
      // Fetch columns as before
      fetch(`/get_columns/${tableId}`)
        .then(res => res.json())
        .then(data => {
          if(data.error) return alert(data.error);
          const columnSelect = document.getElementById('columnSelect');
          columnSelect.innerHTML = '<option value="" disabled selected>Select Column</option>';
          data.columns.forEach(col => {
            const opt = document.createElement('option');
            opt.value = col.id;
            opt.textContent = col.name;
            columnSelect.appendChild(opt);
          });
        })
        .catch(err => console.error(err));
      
      // Fetch factiva articles for the selected table
      fetch(`/get_factiva_articles/${tableId}`)
        .then(res => res.json())
        .then(data => {
          const ul = document.getElementById('factivaArticlesList');
          if(data.error) {
            ul.innerHTML = `<li>Error: ${data.error}</li>`;
            return;
          }
          ul.innerHTML = '';
          if(data.factiva_articles && data.factiva_articles.length > 0) {
            data.factiva_articles.forEach(article => {
              const li = document.createElement('li');
              li.textContent = `${article.headline} by ${article.author}`;
              ul.appendChild(li);
            });
          } else {
            ul.innerHTML = '<li>No Factiva articles uploaded.</li>';
          }
        })
        .catch(err => console.error(err));
    });

    // Column "Show Column" handling remains unchanged
    document.getElementById('showColumn').addEventListener('click', function(){
      const columnId = document.getElementById('columnSelect').value;
      if (!columnId) return alert("Please select a column.");
      fetch(`/get_column/${columnId}`)
        .then(res => res.json())
        .then(data => {
          if(data.error) return alert(data.error);
          document.getElementById('columnDisplay').innerHTML = data.html;
        })
        .catch(err => console.error(err));
    });

    // Factiva form handling remains unchanged
    document.getElementById('factivaForm').addEventListener('submit', function(e){
      e.preventDefault();
      const formData = new FormData(this);
      fetch(this.action, { method: 'POST', body: formData })
        .then(res => res.json())
        .then(data => {
          if(data.error) {
            alert(data.error);
            return;
          }
          alert(data.message);
          // Update the factiva articles list using updated data from POST response
          const ul = document.getElementById('factivaArticlesList');
          ul.innerHTML = '';
          data.factiva_articles.forEach(article => {
            const li = document.createElement('li');
            li.textContent = `${article.headline} by ${article.author}`;
            ul.appendChild(li);
          });
        })
        .catch(err => {
          console.error(err);
          alert('Error uploading factiva articles.');
        });
    });
  </script>
{% endblock %}
